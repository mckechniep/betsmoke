// This tells Prisma which database type to use
datasource db {
  provider = "postgresql"
  // Note: URL is now configured in prisma.config.ts
}

// This tells Prisma to generate a JavaScript/TypeScript client
generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

// ============================================
// ENUMS
// ============================================

// Odds display format preference
// - AMERICAN: +150, -110 (US style)
// - DECIMAL: 2.50, 1.91 (European style)
// - FRACTIONAL: 3/2, 10/11 (UK style)
enum OddsFormat {
  AMERICAN
  DECIMAL
  FRACTIONAL
}

// Defines the allowed context types for notes
// These map to the categories users can tag notes with:
//   - team: Team-related research (e.g., Arsenal form analysis)
//   - fixture: Match-specific notes (e.g., Arsenal vs Chelsea preview)
//   - player: Player-focused research (e.g., Haaland goal patterns)
//   - league: League/competition notes (e.g., Premier League trends)
//   - betting: Betting strategy/system notes (e.g., BTTS research)
//   - general: Uncategorized notes
enum ContextType {
  team
  fixture
  player
  league
  betting
  general
}

// ============================================
// MODELS
// ============================================

// Our User table
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ============================================
  // USER PREFERENCES
  // ============================================
  // Odds format: how betting odds are displayed
  // Default: AMERICAN (US-style odds like +150, -110)
  oddsFormat  OddsFormat @default(AMERICAN)
  
  // Timezone: IANA timezone string (e.g., "America/New_York")
  // Used for displaying match times in user's local time
  // Default: Eastern Time (US)
  timezone    String     @default("America/New_York")

  // ============================================
  // ACCOUNT RECOVERY (Optional)
  // ============================================
  // Security question for backup account recovery
  // (in case user can't access their email)
  securityQuestion  String?   // e.g., "What was your first pet's name?"
  securityAnswer    String?   // Hashed answer (like password)

  // ============================================
  // RELATIONSHIPS
  // ============================================
  // A user can have many notes
  notes     Note[]
  
  // A user can have many password reset requests
  passwordResets PasswordReset[]
}

// Our Note table
model Note {
  id          String      @id @default(uuid())
  title       String
  content     String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relationship: Each note belongs to one user
  userId      String
  user        User        @relation(fields: [userId], references: [id])

  // Relationship: A note can have many context links
  links       NoteLink[]
}

// Junction table: Links notes to multiple contexts (teams, fixtures, etc.)
model NoteLink {
  id          String      @id @default(uuid())
  noteId      String
  note        Note        @relation(fields: [noteId], references: [id], onDelete: Cascade)
  contextType ContextType
  contextId   String      // SportsMonks ID (empty string for general/category-only)
  label       String?     // Human-readable name (e.g., "Arsenal" instead of just "19")
  isPrimary   Boolean     @default(false)
  createdAt   DateTime    @default(now())

  // Ensure a note doesn't link to the same context twice
  @@unique([noteId, contextType, contextId])
}

// ============================================
// PASSWORD RESET
// ============================================
// Stores password reset tokens for email-based account recovery.
// Tokens are hashed (like passwords) for security.
// Each token can only be used once and expires after 1 hour.
model PasswordReset {
  id          String    @id @default(uuid())
  
  // The user requesting the password reset
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // The reset token (hashed for security)
  // The unhashed token is sent to the user's email
  token       String
  
  // When this token expires (typically 1 hour from creation)
  expiresAt   DateTime
  
  // Whether this token has been used
  // Once used, it cannot be used again
  used        Boolean   @default(false)
  
  // Timestamps
  createdAt   DateTime  @default(now())
}